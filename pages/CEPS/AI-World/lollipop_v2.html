<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>AI World Lollipop Chart</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
html, body { height: 100%; }
body {
  margin: 0;
  overflow: hidden;
  background: #ffffff;
  color: #111;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif;
  height: 100vh;
}

.viz-grid {
  display: grid;
  grid-template-rows: 18fr 1fr;
  grid-template-columns: 1fr 1fr;
  height: 100vh;
  width: 100vw;
  box-sizing: border-box;
  padding-bottom: clamp(8px, 2vh, 18px);
}

#container1 {
  grid-row: 1;
  grid-column: 1 / span 2;
  display: flex;
  overflow: hidden;
  min-height: 0;
  column-gap: 0;
  padding: clamp(12px, 2.4vw, 28px) clamp(12px, 2.4vw, 28px) clamp(12px, 2.4vw, 28px) clamp(20px, 3vw, 40px);
  box-sizing: border-box;
}

#container1 .chart-wrapper {
  flex: 1 1 auto;
  display: flex;
  min-width: 0;
  min-height: 0;
}

#container1 .chart-wrapper-inner {
  flex: 1 1 auto;
  display: flex;
  min-width: 0;
  min-height: 0;
  width: 100%;
  border-radius: 0;
  background: none;
  box-shadow: none;
  padding: 0;
}

#viz {
  position: relative;
  width: 100%;
  height: 100%;
  min-width: 0;
  min-height: 0;
}

#chart {
  display: block;
  width: 100%;
  height: 100%;
}

#tooltip {
  position: absolute;
  background: #fff;
  border: 1px solid #d9d9df;
  border-radius: 6px;
  padding: 6px 8px;
  font-size: 12px;
  pointer-events: none;
  opacity: 0;
  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.08);
  transition: opacity .12s ease;
}

#tooltip:after {
  content: "";
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: -6px;
  border-width: 6px 6px 0 6px;
  border-style: solid;
  border-color: #d9d9df transparent transparent transparent;
}

#tooltip:before {
  content: "";
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: -7px;
  border-width: 7px 7px 0 7px;
  border-style: solid;
  border-color: #fff transparent transparent transparent;
}

#container3 {
  grid-row: 2;
  grid-column: 1;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  padding: 0 clamp(20px, 3vw, 40px);
  overflow: hidden;
  min-width: 0;
  box-sizing: border-box;
}

#container4 {
  grid-row: 2;
  grid-column: 2;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding: 0 clamp(20px, 3vw, 40px);
  gap: clamp(10px, 2vw, 16px);
  overflow: hidden;
  min-width: 0;
  box-sizing: border-box;
}

#container4 a{
  height:100%;
  display:flex;
  align-items:center;
}

.logo {
  height: 100%;
  width: auto;
  max-height: 100%;
  max-width: 100%;
  pointer-events: auto;
  object-fit: contain;
}

.source-text {
  font-size: clamp(10px, 1.6vw, 16px);
  font-weight: 600;
  color: #333;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
  font-style: normal;
}

.source-text a {
  color: #2756d3;
  text-decoration: underline;
  cursor: pointer;
}

.source-text a:visited {
  color: #2756d3;
}

.axis path,
.axis line {
  stroke: #cfd2d7;
}

.tick text {
  font-size: clamp(9px, 1vw, 14px);
  font-weight: 600;
  fill: #333;
}

.row-bg {
  transition: fill .2s ease;
}

@media (max-height: 440px) {
  .viz-grid {
    grid-template-rows: 1fr;
    grid-template-columns: 1fr;
    padding-bottom: 0;
  }

  #container1 {
    grid-row: 1;
    grid-column: 1;
  }

  #container3,
  #container4 {
    display: none !important;
  }
}
</style>
</head>
<body>
<div class="viz-grid">
  <div id="container1" class="container chart-container">
    <div class="chart-wrapper">
      <div class="chart-wrapper-inner">
        <div id="viz">
          <svg id="chart"></svg>
          <div id="tooltip"></div>
        </div>
      </div>
    </div>
  </div>
  <div id="container3" class="container source-container">
    <div class="source-text">Source: <a href="https://huggingface.co" target="_blank" rel="noopener">Hugging Face</a></div>
  </div>
  <div id="container4" class="container logo-container">
    <a href="https://aiworld.eu" target="_blank" rel="noopener">
      <img src="https://aiworld.eu/logo-transparent.svg" class="logo" alt="AI World logo">
    </a>
  </div>
</div>
<script>
const tooltip = d3.select("#tooltip");
const svg = d3.select("#chart");
const data = [
  {id: "Ai2", x: 455, y: 1057},
  {id: "NVIDIA", x: 182, y: 547},
  {id: "Meta Llama", x: 2036, y: 2372},
  {id: "Hugging Face", x: 471, y: 749},
  {id: "Qwen", x: 110, y: 348},
  {id: "Google", x: 900, y: 1110},
  {id: "Microsoft", x: 357, y: 501},
  {id: "IBM Granite", x: 34, y: 130},
  {id: "ByteDance", x: 15, y: 108},
  {id: "Apple", x: 81, y: 116},
  {id: "DeepSeek", x: 46, y: 81},
  {id: "Stability AI", x: 93, y: 122},
  {id: "Mistral AI", x: 14, y: 39},
  {id: "Cohere Labs", x: 18, y: 39},
  {id: "OpenAI", x: 39, y: 44}
];

const addLogo = (id) => {
  if (!id) {
    console.error("Missing id:", id);
    return '';
  }
  const logoPath = `./orgs-icons/${id.toLowerCase().replace(/\s+/g, '-')}.png`;
  return logoPath;
};

data.forEach(d => {
  d.delta = d.y - d.x;
  d.inc = d.delta > 0;
  d.dec = d.delta < 0;
  d.same = Math.abs(d.delta) < 0.01;
});

const startColor = "#cccccc"; 
const upColor = "#2ecc71"; 
const downColor = "#e74c3c";

data.sort((a,b) => (b.x+b.y) - (a.x+a.y));
data.sort((a, b) => Math.abs(b.delta) - Math.abs(a.delta));

function createChart() {
  svg.selectAll("*").remove();

  const vizElement = document.getElementById("viz");
  if (!vizElement) return;

  const rect = vizElement.getBoundingClientRect();
  const containerWidth = Math.max(1, rect.width);
  const containerHeight = Math.max(1, rect.height);
  const isCompact = containerWidth < 840 || containerHeight < 540;
  const isTiny = containerWidth < 560 || containerHeight < 410;

  const tempSvg = d3.select("body").append("svg").style("visibility", "hidden");
  const tempText = tempSvg.append("text").style("font-size", "12px").style("font-family", "sans-serif");

  let maxLabelWidth = 0;
  data.forEach(d => {
    tempText.text(d.id);
    const textWidth = tempText.node().getBoundingClientRect().width;
    maxLabelWidth = Math.max(maxLabelWidth, textWidth);
  });

  tempSvg.remove();

  const axisLogoSize = Math.max(12, Math.min(isTiny ? 18 : isCompact ? 22 : 26, containerWidth * 0.032, containerHeight * 0.04));
  const labelPadding = Math.max(isTiny ? 14 : 20, axisLogoSize + (isTiny ? 12 : 16));
  const dynamicLeftMargin = Math.max(40, Math.min(maxLabelWidth + labelPadding + 12, containerWidth * 0.45));

  const margin = {
    top: Math.min(Math.max(isTiny ? 10 : 14, containerHeight * 0.032), 40),
    right: Math.min(Math.max(isTiny ? 18 : isCompact ? 26 : 34, containerWidth * 0.065), 104),
    bottom: Math.min(Math.max(isTiny ? 22 : isCompact ? 30 : 38, containerHeight * 0.085), isTiny ? 58 : isCompact ? 72 : 92),
    left: dynamicLeftMargin
  };

  const width = Math.max(containerWidth - margin.left - margin.right, 1);
  const availableInnerHeight = Math.max(containerHeight - margin.top - margin.bottom, 1);
  const targetInnerHeight = data.length * (isTiny ? 30 : isCompact ? 34 : 40);
  const density = Math.min(1, availableInnerHeight / targetInnerHeight);
  const bandPadding = Math.max(0.2, Math.min(0.6, 0.2 + density * 0.4));
  const height = availableInnerHeight;

  svg
    .attr("width", containerWidth)
    .attr("height", containerHeight)
    .attr("viewBox", `0 0 ${containerWidth} ${containerHeight}`)
    .style("width", "100%")
    .style("height", "100%");

  const defs = svg.append("defs");
  defs.append("marker")
    .attr("id","arrowGreen")
    .attr("viewBox","0 0 10 10")
    .attr("refX",10)
    .attr("refY",5)
    .attr("markerWidth",12)
    .attr("markerHeight",12)
    .attr("orient","auto")
    .attr("markerUnits","userSpaceOnUse")
    .append("path")
    .attr("d","M 0 0 L 10 5 L 0 10 z")
    .attr("fill", "#2ecc71");

  defs.append("marker")
    .attr("id","arrowRed")
    .attr("viewBox","0 0 10 10")
    .attr("refX",0)
    .attr("refY",5)
    .attr("markerWidth",12)
    .attr("markerHeight",12)
    .attr("orient","auto")
    .attr("markerUnits","userSpaceOnUse")
    .append("path")
    .attr("d","M 10 0 L 0 5 L 10 10 z")
    .attr("fill", "#e74c3c");

  const g = svg.append("g").attr("transform",`translate(${margin.left},${margin.top})`);

  const xMin = d3.min(data, d => Math.min(d.x, d.y));
  const xMax = d3.max(data, d => Math.max(d.x, d.y));
  const x = d3.scaleLinear()
    .domain([
      Math.min(0, xMin) - (xMax - xMin) * 0.02,
      xMax + (xMax - xMin) * 0.1
    ]).nice()
    .range([0, width]);
  const y = d3.scaleBand()
    .domain(data.map(d => d.id))
    .range([0, height])
    .padding(bandPadding);

  const step = y.step();
  const padGap = (step - y.bandwidth()) / 2;

  const rowBackgrounds = g.selectAll("rect.row-bg").data(data);
  rowBackgrounds.enter().append("rect")
    .attr("class","row-bg")
    .attr("x", -margin.left)
    .attr("y", d => y(d.id) - padGap)
    .attr("width", containerWidth)
    .attr("height", step)
    .attr("fill", (d,i) => i % 2 ? "rgba(0,0,0,0.035)" : "rgba(255,255,255,0)")
    .attr("pointer-events","none");
  g.selectAll("rect.row-bg").lower();

  const axisLeft = d3.axisLeft(y).tickSize(0);
  const yAxisGroup = g.append("g").attr("class", "axis").call(axisLeft);
  yAxisGroup.select(".domain").remove();

  const logoSize = axisLogoSize;
  const logoOffset = isTiny ? 3 : isCompact ? 5 : 6;

  yAxisGroup.selectAll("text")
    .attr("x", -(logoSize + logoOffset + 8))
    .attr("dy", "0.32em");

  yAxisGroup.selectAll(".tick")
    .each(function(d) {
      const logoPath = addLogo(d);
      const text = d3.select(this).select("text");
      d3.select(this)
        .append("image")
        .attr("x", -(logoOffset + logoSize))
        .attr("y", -(logoSize / 2))
        .attr("width", logoSize)
        .attr("height", logoSize)
        .attr("xlink:href", logoPath)
        .attr("aria-hidden", "true");
      text.attr("text-anchor", "end");
    });

  const xAxis = d3.axisBottom(x).tickValues(x.ticks().filter(d => d >= 0));
  g.append("g").attr("class", "axis")
    .attr("transform", `translate(0,${height})`)
    .call(xAxis);

  if (isTiny) {
    g.selectAll(".axis text").style("font-size", "8px");
  } else if (isCompact) {
    g.selectAll(".axis text").style("font-size", "9px");
  }

  const axisLabelOffset = Math.min(Math.max(18, margin.bottom - 10), isTiny ? 38 : 46);
  g.append("text")
    .attr("transform", `translate(${width / 2}, ${height + axisLabelOffset})`)
    .style("text-anchor", "middle")
    .style("font-size", isTiny ? "9px" : isCompact ? "10px" : "12px")
    .style("fill", "#666")
    .text("Number of Hugging Face Repositories");

  const rNode = isTiny ? 4.5 : isCompact ? 6 : 8;
  const rNodeLarge = isTiny ? 7.5 : isCompact ? 10 : 14;
  const minArrow = isTiny ? 10 : isCompact ? 12 : 14;

  g.selectAll("line.lolli").data(data.filter(d=>!d.same)).enter().append("line")
    .attr("class", "lolli")
    .attr("data-id", d => d.id)
    .attr("y1", d => y(d.id) + y.bandwidth()/2)
    .attr("y2", d => y(d.id) + y.bandwidth()/2)
    .attr("x1", d => d.inc ? x(d.x) + rNode : x(d.y) + rNode)
    .attr("x2", d => d.inc ? x(d.y) - rNode : x(d.x) - rNode)
    .attr("stroke", d => d.inc ? upColor : downColor)
    .attr("stroke-width", 3)
    .attr("stroke-linecap", "round")
    .attr("marker-end", d => (d.inc && Math.abs(x(d.y) - x(d.x)) > minArrow) ? "url(#arrowGreen)" : null)
    .attr("marker-start", d => (d.dec && Math.abs(x(d.x) - x(d.y)) > minArrow) ? "url(#arrowRed)" : null);
    
  const formatNumber = (num) => {
    return num % 1 === 0 ? num.toString() : num.toFixed(2);
  };

  const showNode = (e, node, val) => {
    const tt = tooltip.style("opacity",1).html(formatNumber(val));
    const nb = node.getBoundingClientRect();
    const tb = tt.node().getBoundingClientRect();
    const left = nb.left + nb.width/2 - tb.width/2 + window.scrollX;
    const top  = nb.top  - tb.height - 12 + window.scrollY;
    tt.style("left", left + "px").style("top", top + "px");
  };
  const hide = () => tooltip.style("opacity", 0);

  const enlargeSimple = function(e, val, d){
    d3.select(this).transition().duration(150).attr("r", rNodeLarge);
    showNode(e, this, val);

    if (!d.same) {
      const line = g.select(`line.lolli[data-id="${d.id}"]`);
      if (d.inc) {
        line.transition().duration(150).attr("x1", x(d.x) + rNodeLarge);
      } else if (d.dec) {
        line.transition().duration(150).attr("x2", x(d.x) - rNodeLarge);
      }
    }
  };
  
  const shrinkSimple = function(d){
    d3.select(this).transition().duration(150).attr("r", rNode); 
    hide();
    if (!d.same) {
      const line = g.select(`line.lolli[data-id="${d.id}"]`);
      if (d.inc) {
        line.transition().duration(150).attr("x1", x(d.x) + rNode);
      } else if (d.dec) {
        line.transition().duration(150).attr("x2", x(d.x) - rNode);
      }
    }
  };
  
  const enlargeWithDelta = function(e, val, d){
    d3.select(this).transition().duration(150).attr("r", rNodeLarge);
    showNode(e, this, val);
    
    if (d.inc && !d.same) {
      g.select(`text.diffUp[data-id="${d.id}"]`)
        .transition().duration(150)
        .attr("font-weight", "bold")
        .attr("font-size", "14px")
        .attr("x", Math.min(width - 4, x(d.y) + 20));
    } else if (d.dec && !d.same) {
      g.select(`text.diffDown[data-id="${d.id}"]`)
        .transition().duration(150)
        .attr("font-weight", "bold")
        .attr("font-size", "14px")
        .attr("x", Math.max(4, x(d.y) - 20));
    }
    
    if (!d.same) {
      const line = g.select(`line.lolli[data-id="${d.id}"]`);
      if (d.inc) {
        line.transition().duration(150).attr("x2", x(d.y) - rNodeLarge);
      } else if (d.dec) {
        line.transition().duration(150).attr("x1", x(d.y) + rNodeLarge);
      }
    }
  };
  
  const shrinkWithDelta = function(d){
    d3.select(this).transition().duration(150).attr("r", rNode); 
    hide();
    
    if (d.inc && !d.same) {
      g.select(`text.diffUp[data-id="${d.id}"]`)
        .transition().duration(150)
        .attr("font-weight", "normal")
        .attr("font-size", "11px")
        .attr("x", Math.min(width - 4, x(d.y) + 12));
    } else if (d.dec && !d.same) {
      g.select(`text.diffDown[data-id="${d.id}"]`)
        .transition().duration(150)
        .attr("font-weight", "normal")
        .attr("font-size", "11px")
        .attr("x", Math.max(4, x(d.y) - 12));
    }
    
    if (!d.same) {
      const line = g.select(`line.lolli[data-id="${d.id}"]`);
      if (d.inc) {
        line.transition().duration(150).attr("x2", x(d.y) - rNode);
      } else if (d.dec) {
        line.transition().duration(150).attr("x1", x(d.y) + rNode);
      }
    }
  };
  
  g.selectAll("circle.a").data(data).enter().append("circle")
    .attr("cx", d => x(d.x))
    .attr("cy", d => y(d.id) + y.bandwidth()/2)
    .attr("r", rNode)
    .attr("fill", startColor)
    .on("mouseover", function(e,d){enlargeSimple.call(this, e, d.x, d);})
    .on("mouseout", function(e,d){shrinkSimple.call(this, d);});
    
  g.selectAll("circle.b").data(data).enter().append("circle")
    .attr("cx",d => x(d.y))
    .attr("cy",d => y(d.id) + y.bandwidth()/2)
    .attr("r", rNode)
    .attr("fill", d => d.same ? startColor : (d.inc ? upColor : downColor))
    .on("mouseover", function(e,d){enlargeWithDelta.call(this,e,d.y, d);})
    .on("mouseout", function(e,d){shrinkWithDelta.call(this, d);});
    
  const diff = d => formatNumber(Math.abs(d.delta));

  g.selectAll("text.diffUp").data(data.filter(d=>d.inc && !d.same)).enter().append("text")
    .attr("class","diffUp")
    .attr("data-id", d => d.id)
    .attr("x", d => Math.min(width - 4, x(d.y) + 12))
    .attr("y", d => y(d.id) + y.bandwidth()/2 + 4)
    .attr("text-anchor","start")
    .attr("fill", upColor)
    .attr("font-size","11px")
    .text(d => "+" + diff(d));
    
  g.selectAll("text.diffDown").data(data.filter(d=>d.dec && !d.same)).enter().append("text")
    .attr("class","diffDown")
    .attr("data-id", d => d.id)
    .attr("x", d => Math.max(4, x(d.y) - 12))
    .attr("y", d => y(d.id) + y.bandwidth()/2 + 4)
    .attr("text-anchor","end")
    .attr("fill", downColor)
    .attr("font-size","11px")
    .text(d => "-" + diff(d));
}

createChart();

let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    createChart();
  }, 250);
});
</script>
</body>
</html>
