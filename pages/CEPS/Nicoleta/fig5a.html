<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:wght@300;400;600&display=swap');

    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100vw;
      height: 100vh;
      background-color: #ffffff;
      font-family: 'Source Sans Pro', sans-serif;
    }
    #my_dataviz {
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>
<body>

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>

<!-- Load color palettes -->
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<script>

// ===== COLOR CONFIGURATION =====
// Edit these constants to change the color scheme
var COLOR_NEGATIVE = "#d73027";
var COLOR_ZERO = "#f7f7f7";
var COLOR_POSITIVE = "#1a9850";
var COLOR_MISSING = "#f0f0f0";
// ===============================

// ===== TYPOGRAPHY CONFIGURATION =====
var FONT_FAMILY = "'Source Sans Pro', sans-serif";
var FONT_SIZE_AXIS = 9;
var FONT_SIZE_LEGEND = 10;
var AXIS_COLOR = "#333333";
// ====================================

// Calculate dimensions to fit window
var windowWidth = window.innerWidth;
var windowHeight = window.innerHeight;
var margin = {top: 60, right: 60, bottom: 80, left: 80};

// Calculate available space
var availableWidth = windowWidth - margin.left - margin.right;
var availableHeight = windowHeight - margin.top - margin.bottom;

// We'll calculate actual width and height after loading data
// to ensure each cell is square
var width, height, cellSize;

// append the svg object to the body of the page
// We'll set dimensions after loading data
var svg = d3.select("#my_dataviz")
.append("svg")
.append("g")
  .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");

//Read the data
d3.csv("fig5a.csv", function(data) {

  // Get column names (excluding 'key' column)
  var columns = data.columns.filter(function(d) { return d !== 'key'; });

  // Transform data into format needed for heatmap
  var transformedData = [];
  data.forEach(function(row) {
    var rowKey = row.key;
    columns.forEach(function(col) {
      transformedData.push({
        row: rowKey,
        column: col,
        value: +row[col]  // Convert to number
      });
    });
  });

  // Labels of row and columns
  var myGroups = columns;
  var myVars = data.map(function(d) { return d.key; });

  // Calculate cell size to make each cell square
  var numCols = myGroups.length;
  var numRows = myVars.length;

  // Calculate the maximum cell size that fits in the available space
  var maxCellWidth = availableWidth / numCols;
  var maxCellHeight = availableHeight / numRows;

  // Use the smaller of the two to ensure squares fit in both dimensions
  cellSize = Math.min(maxCellWidth, maxCellHeight);

  // Calculate actual width and height based on square cells
  width = cellSize * numCols;
  height = cellSize * numRows;

  // Set SVG dimensions now that we know them
  d3.select("#my_dataviz svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

  // Build X scales and axis:
  var x = d3.scaleBand()
    .range([ 0, width ])
    .domain(myGroups)
    .padding(0.05);
  svg.append("g")
    .attr("class", "x-axis")
    .style("font-size", FONT_SIZE_AXIS + "px")
    .style("font-family", FONT_FAMILY)
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).tickSize(0))
    .selectAll("text")
      .style("text-anchor", "end")
      .style("fill", AXIS_COLOR)
      .attr("dx", "-.8em")
      .attr("dy", ".15em")
      .attr("transform", "rotate(-65)");
  svg.select(".x-axis .domain").remove()

  // Add X-axis title
  svg.append("text")
    .attr("class", "x-axis-title")
    .attr("x", width / 2)
    .attr("y", height + 70)
    .attr("text-anchor", "middle")
    .style("font-size", "16px")
    .style("font-family", FONT_FAMILY)
    .style("font-weight", "600")
    .style("fill", AXIS_COLOR)
    .text("AI Hub");

  // Build Y scales and axis:
  var y = d3.scaleBand()
    .range([ height, 0 ])
    .domain(myVars)
    .padding(0.05);
  svg.append("g")
    .attr("class", "y-axis")
    .style("font-size", FONT_SIZE_AXIS + "px")
    .style("font-family", FONT_FAMILY)
    .call(d3.axisLeft(y).tickSize(0))
    .selectAll("text")
      .style("fill", AXIS_COLOR);
  svg.select(".y-axis .domain").remove()

  // Add Y-axis title
  svg.append("text")
    .attr("class", "y-axis-title")
    .attr("transform", "rotate(-90)")
    .attr("x", -height / 2)
    .attr("y", -60)
    .attr("text-anchor", "middle")
    .style("font-size", "16px")
    .style("font-family", FONT_FAMILY)
    .style("font-weight", "600")
    .style("fill", AXIS_COLOR)
    .text("AI Hub");

  // Build diverging color scale from -1 (red) to 0 (white) to 1 (green)
  var myColor = d3.scaleLinear()
    .domain([-1, 0, 1])
    .range([COLOR_NEGATIVE, COLOR_ZERO, COLOR_POSITIVE])
    .clamp(true)

  // add the squares
  svg.selectAll()
    .data(transformedData, function(d) {return d.row+':'+d.column;})
    .enter()
    .append("rect")
      .attr("x", function(d) { return x(d.column) })
      .attr("y", function(d) { return y(d.row) })
      .attr("rx", 1)
      .attr("ry", 1)
      .attr("width", x.bandwidth() )
      .attr("height", y.bandwidth() )
      .style("fill", function(d) {
        // Paint diagonal (self-intersecting) values in gray
        if (d.row === d.column) {
          return "#cccccc";
        }
        return myColor(d.value);
      })
      .style("stroke", function(d) {
        // Bright yellow border for same country (first 2 letters match), but not for diagonal cells
        if (d.row === d.column) {
          return "#ffffff";
        }
        return d.row.substring(0, 2) === d.column.substring(0, 2) ? "#FFD700" : "#ffffff";
      })
      .style("stroke-width", function(d) {
        // Thicker border for same country, but not for diagonal cells
        if (d.row === d.column) {
          return 0.5;
        }
        return d.row.substring(0, 2) === d.column.substring(0, 2) ? 3 : 0.5;
      })
      .style("cursor", "pointer")
      .on("mouseover", function(d) {
        // Highlight the hovered square
        d3.select(this)
          .style("opacity", 0.7);
      })
      .on("mouseout", function(d) {
        // Remove highlight
        d3.select(this)
          .style("opacity", 1);
      })

  // Add value labels (shown only for values outside -1 to +1 range, or on hover)
  var valueLabels = svg.selectAll()
    .data(transformedData, function(d) {return d.row+':'+d.column+'_value';})
    .enter()
    .append("text")
      .attr("class", "value-label")
      .attr("x", function(d) { return x(d.column) + x.bandwidth() / 2 })
      .attr("y", function(d) { return y(d.row) + y.bandwidth() / 2 })
      .attr("text-anchor", "middle")
      .attr("dominant-baseline", "central")
      .style("font-size", Math.min(x.bandwidth(), y.bandwidth()) * 0.35 + "px")
      .style("font-family", FONT_FAMILY)
      .style("font-weight", "600")
      .style("fill", "#ffffff")
      .style("pointer-events", "none")
      .style("opacity", function(d) {
        // Show label only if value is outside -1 to +1 range
        return (d.value < -1 || d.value > 1) ? 1 : 0;
      })
      .text(function(d) {
        return d.value.toFixed(1);
      });

  // Update hover effects to show value labels
  svg.selectAll("rect")
    .on("mouseover", function(d) {
      // Skip diagonal cells (self-intersecting)
      if (d.row === d.column) {
        return;
      }

      // Highlight the hovered square
      d3.select(this)
        .style("opacity", 0.7);

      // Show the corresponding value label
      valueLabels.filter(function(label) {
        return label.row === d.row && label.column === d.column;
      })
      .transition()
      .duration(100)
      .style("opacity", 1);
    })
    .on("mouseout", function(d) {
      // Skip diagonal cells (self-intersecting)
      if (d.row === d.column) {
        return;
      }

      // Remove highlight
      d3.select(this)
        .style("opacity", 1);

      // Hide the value label if it's not an outlier
      valueLabels.filter(function(label) {
        return label.row === d.row && label.column === d.column;
      })
      .transition()
      .duration(100)
      .style("opacity", function(label) {
        return (label.value < -1 || label.value > 1) ? 1 : 0;
      });
    });

  // Add spacebar event listeners
  d3.select("body")
    .on("keydown", function() {
      if (d3.event.keyCode === 32) {  // Spacebar key code
        d3.event.preventDefault();
        valueLabels.transition().duration(150).style("opacity", 1);
      }
    })
    .on("keyup", function() {
      if (d3.event.keyCode === 32) {  // Spacebar key code
        d3.event.preventDefault();
        valueLabels.transition().duration(150).style("opacity", 0);
      }
    });

  // Add color scale legend
  var legendWidth = 20;
  var legendHeight = height * 0.4;  // Make legend 40% of heatmap height
  var legendMargin = 40;
  var legendOffsetY = (height - legendHeight) / 2;  // Center the legend vertically

  // Create gradient
  var defs = svg.append("defs");
  var linearGradient = defs.append("linearGradient")
    .attr("id", "legend-gradient")
    .attr("x1", "0%")
    .attr("y1", "0%")
    .attr("x2", "0%")
    .attr("y2", "100%");

  linearGradient.append("stop")
    .attr("offset", "0%")
    .attr("stop-color", COLOR_POSITIVE);

  linearGradient.append("stop")
    .attr("offset", "50%")
    .attr("stop-color", COLOR_ZERO);

  linearGradient.append("stop")
    .attr("offset", "100%")
    .attr("stop-color", COLOR_NEGATIVE);

  // Draw legend rectangle
  var legend = svg.append("g")
    .attr("transform", "translate(" + (width + legendMargin) + ", " + legendOffsetY + ")");

  legend.append("rect")
    .attr("width", legendWidth)
    .attr("height", legendHeight)
    .attr("rx", 2)
    .attr("ry", 2)
    .style("fill", "url(#legend-gradient)")
    .style("stroke", "#cccccc")
    .style("stroke-width", 0.5);

  // Add scale axis
  var legendScale = d3.scaleLinear()
    .domain([1, -1])
    .range([0, legendHeight]);

  var legendAxis = d3.axisRight(legendScale)
    .ticks(5)
    .tickFormat(d3.format(".1f"));

  legend.append("g")
    .attr("class", "legend-axis")
    .attr("transform", "translate(" + legendWidth + ", 0)")
    .style("font-size", FONT_SIZE_LEGEND + "px")
    .style("font-family", FONT_FAMILY)
    .call(legendAxis)
    .selectAll("text")
      .style("fill", AXIS_COLOR);

  legend.select(".legend-axis .domain").remove();
  legend.selectAll(".legend-axis .tick line")
    .style("stroke", "#cccccc");

  // Add label above legend bar
  legend.append("text")
    .attr("x", legendWidth / 2)
    .attr("y", -10)
    .attr("text-anchor", "middle")
    .style("font-size", FONT_SIZE_LEGEND + "px")
    .style("font-family", FONT_FAMILY)
    .style("font-weight", "600")
    .style("fill", AXIS_COLOR)
    .text("1+");

  // Add label below legend bar
  legend.append("text")
    .attr("x", legendWidth / 2)
    .attr("y", legendHeight + 20)
    .attr("text-anchor", "middle")
    .style("font-size", FONT_SIZE_LEGEND + "px")
    .style("font-family", FONT_FAMILY)
    .style("font-weight", "600")
    .style("fill", AXIS_COLOR)
    .text("-1");

  // Style all axis tick lines
  svg.selectAll(".x-axis .tick line, .y-axis .tick line")
    .style("stroke", "#e0e0e0");

  // Add footnote with yellow square indicator
  var footnote = svg.append("g")
    .attr("transform", "translate(" + (width - 130) + ", " + (height + 60) + ")");

  // Draw yellow square
  footnote.append("rect")
    .attr("x", 0)
    .attr("y", -10)
    .attr("width", 12)
    .attr("height", 12)
    .attr("rx", 1)
    .attr("ry", 1)
    .style("fill", "#f7f7f7")
    .style("stroke", "#FFD700")
    .style("stroke-width", 2.5);

  // Add text
  footnote.append("text")
    .attr("x", 18)
    .attr("y", 0)
    .attr("text-anchor", "start")
    .style("font-size", "18px")
    .style("font-family", FONT_FAMILY)
    .style("fill", AXIS_COLOR)
    .text("Same country");
})

</script>
</body>
</html>
