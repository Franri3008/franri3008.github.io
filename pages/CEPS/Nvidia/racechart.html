<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HF Orgs Race Chart</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
html,body{margin:0;padding:0;overflow:hidden;height:100%;width:100%;}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f9f9f9;}
#wrap{position:relative;width:100%;height:100vh;display:flex;flex-direction:column;}
#toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;padding:10px;background:#fff;border-bottom:1px solid #e6e6e6;}
.btn{padding:6px 10px;border-radius:8px;border:1px solid #cfd2d7;background:#fff;font-weight:700;cursor:pointer;user-select:none;}
.btn.active{background:#2756d3;color:#fff;border-color:#2756d3;}
#chart{flex:1 1 auto;width:100%;}
.axis text{font-size:12px;}
.ticker{font-size:clamp(20px,5vw,64px);font-weight:800;fill:#222;}
.label{font-size:14px;font-weight:800;fill:#111;text-anchor:end;}
</style>
</head>
<body>
<div id="wrap">
  <div id="toolbar"></div>
  <div id="chart"></div>
</div>
<script>
const metrics=[{key:"repos_total",label:"Repos"},{key:"likes_total",label:"Likes"},{key:"downloads_total",label:"Downloads"},{key:"spaces_total",label:"Spaces"},{key:"datasets_total",label:"Datasets"},{key:"models_total",label:"Models"}];
let currentMetric="repos_total";
const k=8;
const duration=120;
const barSize=46;
const margin={top:32,right:240,bottom:28,left:120};
let svg,barG,labelG,valueG,axisG,ticker;
let xScale,yScale,xAxis;
let keyframes=[];
let names=[];
let playing=false;
function dims(){const r=document.getElementById("chart").getBoundingClientRect();return{width:Math.max(720,r.width),height:Math.max(560,r.height)};}
function buildToolbar(){
  const tb=d3.select("#toolbar");
  const btns=tb.selectAll("button.btn").data(metrics,d=>d.key).join("button").attr("class",d=>"btn"+(d.key===currentMetric?" active":"")).text(d=>d.label);
  btns.on("click",(_,d)=>{currentMetric=d.key;tb.selectAll("button.btn").classed("active",b=>b.key===currentMetric);restart();});
}
async function load(){
  const json=await fetch("./data.json").then(r=>r.json());
  names=Array.from(new Set(json.map(d=>d.id)));
  buildToolbar();
  initSvg();
  buildKeyframes(json);
  start();
}
function buildKeyframes(raw){
  const byId=d3.group(raw,d=>d.id);
  const minW=d3.min(raw,d=>+d.week_count);
  const maxW=d3.max(raw,d=>+d.week_count);
  const frames=[];
  for(let w=minW;w<=maxW;w++){
    const map=new Map();
    for(const id of byId.keys()){
      const arr=byId.get(id).sort((a,b)=>+a.week_count-+b.week_count);
      let last=0;
      for(const r of arr){ if(+r.week_count<=w){ last=+r[currentMetric]; } else { break; } }
      map.set(id,last);
    }
    frames.push([w,map]);
  }
  keyframes=[];
  for(let i=0;i<frames.length-1;i++){
    const [wa,a]=frames[i];
    const [wb,b]=frames[i+1];
    for(let j=0;j<k;j++){
      const t=j/k;
      const xVal=wa+(wb-wa)*t;
      const rank=names.map(name=>({name,value:(a.get(name)||0)*(1-t)+(b.get(name)||0)*t})).sort((a,b)=>d3.descending(a.value,b.value)).map((d,i)=>({name:d.name,value:d.value,rank:i+1}));
      keyframes.push([xVal,rank]);
    }
  }
  const [wl,bl]=frames[frames.length-1];
  const last=names.map(name=>({name,value:bl.get(name)||0})).sort((a,b)=>d3.descending(a.value,b.value)).map((d,i)=>({name:d.name,value:d.value,rank:i+1}));
  keyframes.push([wl,last]);
}
function initSvg(){
  d3.select("#chart").selectAll("*").remove();
  const {width,height}=dims();
  svg=d3.select("#chart").append("svg").attr("width","100%").attr("height","100%").attr("viewBox",`0 0 ${width} ${height}`).attr("preserveAspectRatio","xMidYMid meet");
  xScale=d3.scaleLinear().range([margin.left,width-margin.right]);
  yScale=d3.scaleBand().range([margin.top,height-margin.bottom]).padding(0.15);
  axisG=svg.append("g").attr("transform",`translate(0,${margin.top})`);
  barG=svg.append("g");
  labelG=svg.append("g");
  valueG=svg.append("g");
  ticker=svg.append("text").attr("class","ticker").attr("x",width-16).attr("y",height-32).attr("text-anchor","end");
  window.addEventListener("resize",layout);
}
function layout(){
  const {width,height}=dims();
  svg.attr("viewBox",`0 0 ${width} ${height}`);
  xScale.range([margin.left,width-margin.right]);
  yScale.range([margin.top,height-margin.bottom]);
  if(keyframes.length){
    const cur=keyframes[0][1].slice(0,20);
    xScale.domain([0,d3.max(cur,d=>d.value)||1]);
    yScale.domain(cur.map(d=>d.name));
    xAxis=d3.axisTop(xScale).ticks(width/160).tickSizeOuter(0).tickSizeInner(-(yScale.bandwidth()+yScale.step())*20);
    axisG.call(xAxis);
    axisG.select(".domain").remove();
  }
}
function start(){playing=true;animate().catch(()=>{});}
function stop(){playing=false;}
function restart(){stop();buildKeyframesCached().then(()=>{start();});}
async function buildKeyframesCached(){const text=await fetch("./data.json").then(r=>r.json());buildKeyframes(text);}
async function animate(){
  const {width,height}=dims();
  const topN=20;
  for(const [xVal,data] of keyframes){
    if(!playing){break;}
    const slice=data.slice(0,topN);
    xScale.domain([0,d3.max(slice,d=>d.value)||1]);
    yScale.domain(slice.map(d=>d.name));
    xAxis=d3.axisTop(xScale).ticks(width/160).tickSizeOuter(0).tickSizeInner(-(yScale.bandwidth()+yScale.step())*topN);
    const t=svg.transition().duration(duration).ease(d3.easeLinear);
    axisG.transition(t).call(xAxis);
    axisG.select(".domain").remove();
    const bars=barG.selectAll("rect.bar").data(slice,d=>d.name);
    bars.join(
      enter=>enter.append("rect").attr("class","bar").attr("x",xScale(0)).attr("y",d=>yScale(d.name)).attr("height",yScale.bandwidth()).attr("width",d=>xScale(d.value)-xScale(0)).attr("fill","#4f71d9").attr("rx",6).attr("ry",6),
      update=>update,
      exit=>exit.remove()
    ).transition(t).attr("y",d=>yScale(d.name)).attr("width",d=>Math.max(0,xScale(d.value)-xScale(0))).attr("height",yScale.bandwidth());
    const labels=labelG.selectAll("text.label").data(slice,d=>d.name);
    labels.join(
      enter=>enter.append("text").attr("class","label").attr("x",xScale(0)-8).attr("y",d=>yScale(d.name)+yScale.bandwidth()/2).attr("dy","0.35em").text(d=>d.name.split("/")[0]),
      update=>update,
      exit=>exit.remove()
    ).transition(t).attr("x",xScale(0)-8).attr("y",d=>yScale(d.name)+yScale.bandwidth()/2);
    const values=valueG.selectAll("text.value").data(slice,d=>d.name);
    values.join(
      enter=>enter.append("text").attr("class","value").attr("text-anchor","end").attr("x",d=>xScale(d.value)-6).attr("y",d=>yScale(d.name)+yScale.bandwidth()/2).attr("dy","0.35em").attr("fill","#fff").attr("font-weight",700).text(d3.format(",")),
      update=>update,
      exit=>exit.remove()
    ).transition(t).attr("x",d=>xScale(d.value)-6).attr("y",d=>yScale(d.name)+yScale.bandwidth()/2).tween("text",function(d){const that=this;const i=d3.interpolateNumber(+that.textContent.replace(/,/g,"")||0,d.value);return s=>that.textContent=d3.format(",")(Math.round(i(s)));});
    ticker.text(`Week ${Math.round(xVal)}`);
    try{await t.end();}catch(e){}
  }
}
load();
</script>
</body>
</html>