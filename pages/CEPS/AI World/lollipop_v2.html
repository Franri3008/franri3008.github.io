<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>AI World Lollipop Chart</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
body{font-family:sans-serif; margin:0; padding:20px;}
.axis path,.axis line{stroke:#bbb;}
.tick text{font-size: 12px;}
#tooltip{position:absolute;background:#fff; border:1px solid #ccc; padding:4px 8px;font-size:12px; pointer-events:none; opacity:0; transition:opacity 0.2s;}
#chart{display:block;margin:0 auto;}
#tooltip:after{content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:-6px;border-width:6px 6px 0 6px;border-style:solid;border-color:#ccc transparent transparent transparent;}
#tooltip:before{content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:-7px;border-width:7px 7px 0 7px;border-style:solid;border-color:#fff transparent transparent transparent;}
</style>
</head>
<body>
<svg id = "chart"></svg>
<div id = "tooltip"></div>
<script>
const tooltip = d3.select("#tooltip");
const data = [
  {id: "Ai2", x: 455, y: 1057},
  {id: "NVIDIA", x: 182, y: 547},
  {id: "Meta Llama", x: 2036, y: 2372},
  {id: "Hugging Face", x: 471, y: 749},
  {id: "Qwen", x: 110, y: 348},
  {id: "Google", x: 900, y: 1110},
  {id: "Microsoft", x: 357, y: 501},
  {id: "IBM Granite", x: 34, y: 130},
  {id: "ByteDance", x: 15, y: 108},
  {id: "Apple", x: 81, y: 116},
  {id: "DeepSeek", x: 46, y: 81},
  {id: "Stability AI", x: 93, y: 122},
  {id: "Mistral AI", x: 14, y: 39},
  {id: "Cohere Labs", x: 18, y: 39},
  {id: "OpenAI", x: 39, y: 44}
];

const tempSvg = d3.select("body").append("svg").style("visibility", "hidden");
const tempText = tempSvg.append("text").style("font-size", "12px").style("font-family", "sans-serif");

let maxLabelWidth = 0;
data.forEach(d => {
  tempText.text(d.id);
  const textWidth = tempText.node().getBoundingClientRect().width;
  maxLabelWidth = Math.max(maxLabelWidth, textWidth);
});

tempSvg.remove();

const logoWidth = 24;
const padding = 16;
const dynamicLeftMargin = maxLabelWidth + logoWidth + padding;

const margin = {top:20, right:30, bottom:20, left: dynamicLeftMargin};
const width = 860 - margin.left - margin.right;

const addLogo = (id) => {
  if (!id) {
    console.error("Missing id:", id);
    return '';
  }
  console.log("Logo ID:", id);
  const logoPath = `./orgs-icons/${id.toLowerCase().replace(/\s+/g, '-')}.png`;
  return logoPath;
};

data.forEach(d => {
  d.delta = d.y - d.x;
  d.inc = d.delta > 0;
  d.dec = d.delta < 0;
  d.same = Math.abs(d.delta) < 0.01;
});
  const startColor = "#cccccc"; const upColor = "#2ecc71"; const downColor = "#e74c3c";
  data.sort((a,b) => (b.x+b.y) - (a.x+a.y));
  data.sort((a, b) => Math.abs(b.delta) - Math.abs(a.delta));
  const height = data.length * 30;
  const svg = d3.select("#chart")
    .attr("width",width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

  const defs = svg.append("defs");
  defs.append("marker")
    .attr("id","arrowGreen")
    .attr("viewBox","0 0 10 10")
    .attr("refX",10)
    .attr("refY",5)
    .attr("markerWidth",12)
    .attr("markerHeight",12)
    .attr("orient","auto")
    .attr("markerUnits","userSpaceOnUse")
    .append("path")
    .attr("d","M 0 0 L 10 5 L 0 10 z")
    .attr("fill", "#2ecc71");

  defs.append("marker")
    .attr("id","arrowRed")
    .attr("viewBox","0 0 10 10")
    .attr("refX",0)
    .attr("refY",5)
    .attr("markerWidth",12)
    .attr("markerHeight",12)
    .attr("orient","auto")
    .attr("markerUnits","userSpaceOnUse")
    .append("path")
    .attr("d","M 10 0 L 0 5 L 10 10 z")
    .attr("fill", "#e74c3c");
  const g = svg.append("g").attr("transform",`translate(${margin.left},${margin.top})`);
  const xMin = d3.min(data, d => Math.min(d.x, d.y));
  const xMax = d3.max(data, d => Math.max(d.x, d.y));
  const x = d3.scaleLinear()
    .domain([Math.min(0, xMin) - (xMax - xMin) * 0.02, xMax]).nice()
    .range([0, width]);
  const y = d3.scaleBand()
    .domain(data.map(d => d.id))
    .range([0, height])
    .padding(0.8);

const step = y.step();
const padGap = (step - y.bandwidth()) / 2;
g.selectAll("rect.row-bg").data(data).enter().append("rect")
  .attr("class","row-bg")
  .attr("x", -margin.left)
  .attr("y", d => y(d.id) - padGap)
  .attr("width", width + margin.left + margin.right)
  .attr("height", step)
  .attr("fill", (d,i) => i % 2 ? "#f5f5f5" : "#ffffff")
  .attr("pointer-events","none")
  .lower();
  const yAxisGroup = g.append("g").attr("class", "axis").call(d3.axisLeft(y));

  yAxisGroup.selectAll(".tick")
    .each(function(d) {
      const logoPath = addLogo(d);
      const text = d3.select(this).select("text");
      d3.select(this)
        .append("image")
        .attr("x", 8)
        .attr("y", -12)
        .attr("width", 24)
        .attr("height", 24)
        .attr("xlink:href", logoPath);
    });
  g.append("g").attr("class", "axis")
    .attr("transform", `translate(0,${height})`)
    .call(d3.axisBottom(x));
  const rNode = 8;
  const minArrow = 14;
  
  g.selectAll("line.lolli").data(data.filter(d=>!d.same)).enter().append("line")
    .attr("class", "lolli")
    .attr("y1", d => y(d.id) + y.bandwidth()/2)
    .attr("y2", d => y(d.id) + y.bandwidth()/2)
    .attr("x1", d => d.inc ? x(d.x) + rNode : x(d.y) + rNode)
    .attr("x2", d => d.inc ? x(d.y) - rNode : x(d.x) - rNode)
    .attr("stroke", d => d.inc ? upColor : downColor)
    .attr("stroke-width", 3)
    .attr("stroke-linecap", "round")
    .attr("marker-end", d => (d.inc && Math.abs(x(d.y) - x(d.x)) > minArrow) ? "url(#arrowGreen)" : null)
    .attr("marker-start", d => (d.dec && Math.abs(x(d.x) - x(d.y)) > minArrow) ? "url(#arrowRed)" : null);
    
  const showNode = (e, node, val) => {
    const tt = tooltip.style("opacity",1).html(val.toFixed(2));
    const nb = node.getBoundingClientRect();
    const tb = tt.node().getBoundingClientRect();
    const left = nb.left + nb.width/2 - tb.width/2 + window.scrollX;
    const top  = nb.top  - tb.height - 12 + window.scrollY;
    tt.style("left", left + "px").style("top", top + "px");
  };
  const hide = () => tooltip.style("opacity", 0);
  const enlarge = function(e, val){
    d3.select(this).transition().duration(150).attr("r", 14);
    showNode(e, this, val);
  };
  const shrink = function(){d3.select(this).transition().duration(150).attr("r", 8); hide();};
  g.selectAll("circle.a").data(data).enter().append("circle")
    .attr("cx", d => x(d.x))
    .attr("cy", d => y(d.id) + y.bandwidth()/2)
    .attr("r", 8)
    .attr("fill", startColor)
    .on("mouseover", function(e,d){enlarge.call(this, e, d.x);})
    .on("mouseout", shrink);
  g.selectAll("circle.b").data(data).enter().append("circle")
    .attr("cx",d => x(d.y))
    .attr("cy",d => y(d.id) + y.bandwidth()/2)
    .attr("r", 8)
    .attr("fill", d => d.same ? startColor : (d.inc ? upColor : downColor))
    .on("mouseover", function(e,d){enlarge.call(this,e,d.y);})
    .on("mouseout", shrink);
    
  const diff = d => Math.abs(d.delta).toFixed(2);

  g.selectAll("text.diffUp").data(data.filter(d=>d.inc && !d.same)).enter().append("text")
    .attr("class","diffUp")
    .attr("x", d => x(d.y) + 12)
    .attr("y", d => y(d.id) + y.bandwidth()/2 + 4)
    .attr("text-anchor","start")
    .attr("fill", upColor)
    .attr("font-size","11px")
    .text(d => "+" + diff(d));
  g.selectAll("text.diffDown").data(data.filter(d=>d.dec && !d.same)).enter().append("text")
    .attr("class","diffDown")
    .attr("x", d => x(d.y) - 12)
    .attr("y", d => y(d.id) + y.bandwidth()/2 + 4)
    .attr("text-anchor","end")
    .attr("fill", downColor)
    .attr("font-size","11px")
    .text(d => "-" + diff(d));
</script>
</body>
</html>