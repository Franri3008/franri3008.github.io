<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>NestorBOT v3.0 - 📅 Horarios</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    /* Contenedor principal en layout flex */
    .page-container {
      display: flex;
      flex-direction: row;
      min-height: 100vh; /* Para que el sidebar se mantenga a la izquierda a todo alto */
    }

    /* Barra lateral izquierda */
    .sidebar-izquierda {
      width: 150px;
      background-color: #f8f8f8;
      border-right: 1px solid #ccc;
      padding: 10px;
      margin-left: 20px;
      box-sizing: border-box; 
    }
    .sidebar-boton {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      text-align: center;
      text-decoration: none;
      border: 1px solid #aaa;
      border-radius: 5px;
      padding: 8px 0;
      color: #333;
      font-weight: bold;
      background-color: #eee;
      cursor: pointer;
    }
    .sidebar-boton-seleccionado {
      background-color: #75BBB0;
      color: #fff;
      border: none;
    }
    .sidebar-boton:hover {
      background-color: #65A4E3;
      color: #fff;
    }

    /* Iconos de descarga en la barra lateral */
    .sidebar-iconos {
      margin-top: 20px;
      text-align: center;
    }
    .sidebar-iconos img {
      width: 30px;
      height: 30px;
      cursor: pointer;
      margin: 10px 5px;
    }
    .sidebar-iconos img:hover {
      opacity: 0.7;
    }

    /* Área de contenido principal */
    .main-content {
      flex: 1;
      display: block;
      box-sizing: border-box;
      padding: 0 20px 20px 20px; 
    }

    /* Cabecera */
    .header-titulo {
      text-align: center;
      background-color: #4b286d;
      color: #fff;
      padding: 15px 0;
      font-size: 1.3rem;
      margin-bottom: 0;
    }

    /* Sección de Modo */
    .modo-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 5px;
    }
    .modo-container button {
      margin: 0 5px;
      padding: 6px 12px;
      cursor: pointer;
      background-color: #b8b8ff;
      border: none;
      border-radius: 5px;
      color: #333;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    .modo-container button:hover {
      background-color: #9797e6;
    }
    /* Color más oscuro para el modo activo */
    .modo-activo {
      background-color: #4840AC;
      color: #fff;
    }

    /* Botones de días */
    .top-dias {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px 0;
    }
    .top-dias button {
      margin: 0 5px;
      padding: 6px 12px;
      cursor: pointer;
      background-color: #2b83f0;
      border: none;
      border-radius: 5px;
      color: #fff;
      font-weight: bold;
    }
    .top-dias button:hover {
      background-color: #1f67b8;
    }
    .top-dias button.activo {
      background-color: #1b5590;
    }

    /* Contenedor principal modo "General" */
    .contenedor-principal {
      padding: 0px 0;
      display: block; /* visible en modo General */
    }

    /* Contenedor principal modo "Por profesor" */
    .contenedor-profesor {
      padding: 20px 0;
      display: none; /* se mostrará solo cuando se presione "Por profesor" */
    }

    /* Contenedor principal modo "Por curso" */
    .contenedor-curso {
      padding: 20px 0;
      display: none; /* se mostrará solo cuando se presione "Por curso" */
    }

    /* Horarios */
    .horarios-contenedor {
      border: 1px solid #aaa;
      border-radius: 5px;
      padding: 10px;
      margin-top: 20px;
      margin-bottom: 20px;
      width: 90%;
      box-sizing: border-box;
    }
    .horarios-contenedor h2 {
      margin: 0 0 10px 0;
      font-size: 1.3rem;
      background-color: #4b286d;
      color: #fff;
      padding: 8px;
      border-radius: 4px;
      text-align: center;
    }
    .contenedor-botones-horarios {
      width: 100%;
      text-align: right;
      margin-bottom: 10px;
    }
    .boton-agregar {
      background-color: #75BBB0;
      border: none;
      color: #fff;
      font-size: 1rem;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 5px;
    }
    .boton-agregar:hover {
      background-color: #65A4E3;
    }
    .tabla-horarios {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
      table-layout: fixed;
    }
    .tabla-horarios th,
    .tabla-horarios td {
      border: 1px solid #ccc;
      padding: 6px;
      vertical-align: top;
      position: relative;
      text-align: center;
    }
    .col-hora {
      width: 4%;
      text-align: center;
      font-size: 0.9em;
    }
    .tabla-horarios thead th {
      font-size: 0.5em;
    }
    .editable {
      outline: 1px dotted transparent;
    }
    .editable:focus {
      outline: 1px dotted #aaa;
    }

    /* Bloques de profesor */
    .profesor-block {
      background-color: #FFD700;
      margin: 2px 0;
      border: 1px solid #aaa;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 0.5em;
      cursor: move;
      position: relative;
      user-select: none;
      display: block;
      width: 100%;
      box-sizing: border-box;
      text-align: center;
    }
    .ramo-line,
    .prof-line {
      display: block;
      margin: 2px 0;
    }

    .recreo td {
      background-color: #eee !important;
      line-height: 0.2;
      height: 0.2em;
      min-height: 1px;
    }

    #colorPicker {
      display: none;
      position: absolute;
      z-index: 9999;
    }

    /* Contenedor de Bloques y sección Profesores */
    #profesorContainer {
      display: flex;
      flex-wrap: wrap;
      margin-top: 20px;
      width: 95%;
      border: 1px dashed #ccc;
      padding: 10px;
      box-sizing: border-box;
    }
    .profesor-item {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-right: 15px;
      margin-bottom: 15px;
    }
    .profesor-item-icons {
      display: flex;
      flex-direction: row;
      gap: 6px;
      align-items: center; 
      justify-content: center;
      margin-top: 5px;
      width: 100%;
    }
    .profesor-item-icons img {
      width: 15px;
      height: 15px;
      cursor: pointer;
      display: inline-block;
      user-select: none;
    }
    .profesor-item-icons img:hover {
      opacity: 0.7;
    }
    .prof-count-span {
      font-size: 0.8em;
      margin-top: 4px;
      display: block;
      text-align: center;
      width: 100%;
    }

    /* Nueva sección para definir lista de profesores */
    #seccionProfesores {
      margin-top: 20px;
      width: 95%;
      border: 1px dashed #ccc;
      padding: 10px;
      box-sizing: border-box;
    }
    #seccionProfesores h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    #listaProfesores {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    #listaProfesores li {
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #listaProfesores li button {
      cursor: pointer;
      padding: 3px 5px;
      border: none;
      border-radius: 3px;
      background-color: #ff5b5b;
      color: #fff;
    }

    .dia-contenedor {
      display: none !important;
    }
    .dia-contenedor.activo {
      display: block !important;
    }

    /* Resaltado */
    .prof-highlight-original {
      outline: 2px dashed #0055FF !important;
      z-index: 2;
      position: relative;
    }
    .prof-highlight-other {
      outline: 2px dashed #222;
      z-index: 2;
      position: relative;
    }
    .prof-faded {
      filter: grayscale(50%);
      opacity: 0.3;
    }

    .drag-over {
      outline: 2px dotted #333 !important;
    }

    /* Tooltip para edición */
    #editTooltip {
      position: absolute;
      width: 300px;
      background: #fff;
      border: 2px solid #333;
      display: none;
      padding: 10px;
      z-index: 10000;
      border-radius: 8px;
    }
    #editTooltip input,
    #editTooltip select {
      width: 90%;
      margin-bottom: 10px;
      font-size: 1em;
      padding: 5px;
    }
    #editTooltip label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    #editTooltip button {
      padding: 6px 12px;
      margin: 3px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    #saveTooltip {
      background-color: #75BBB0;
      color: #fff;
    }
    #cancelTooltip {
      background-color: #eeeeee;
    }

    /* Sección contenedor de horario por profesor */
    .prof-selector {
      margin-bottom: 10px;
      display: flex;
    }
    .prof-selector label {
      margin-right: 10px;
      font-weight: bold;
      font-size: 1em;
      line-height: 2em;
    }
    .prof-selector select {
      font-size: 1em;
      padding: 5px;
    }
    .profesor-activo {
      margin-left: 20px;
      font-style: italic;
      font-weight: bold;
      color: #444;
    }

    /* Sección contenedor de horario "Por curso" */
    .curso-selector {
      margin-bottom: 10px;
      display: flex;
    }
    .curso-selector label {
      margin-right: 10px;
      font-weight: bold;
      font-size: 1em;
      line-height: 2em;
    }
    .curso-selector select {
      font-size: 1em;
      padding: 5px;
    }
    .curso-activo {
      margin-left: 20px;
      font-style: italic;
      font-weight: bold;
      color: #444;
    }
  </style>
</head>
<body>

  <!-- Cabecera arriba -->
  <div class="header-titulo">NestorBOT v3.0 - 📅 Horarios</div>

  <!-- Estructura en flex: sidebar a la izquierda, contenido principal a la derecha -->
  <div class="page-container">

    <!-- Barra lateral izquierda -->
    <div class="sidebar-izquierda">
      <a href="conversor.html" class="sidebar-boton">↔️ Conversor</a>
      <a class="sidebar-boton sidebar-boton-seleccionado">📅 Horarios</a>
      <a class="sidebar-boton" href="index.html">🏠 Menú Principal</a>

      <!-- Iconos de descarga JSON / Excel -->
      <div class="sidebar-iconos">
        <!-- JSON -->
        <img src="download-icon.svg"
             title="Descargar JSON"
             onclick="guardarEnJSON()" />

        <!-- EXCEL -->
        <img src="excel-icon.svg"
             title="Descargar Excel"
             onclick="descargarExcelSegunModo()" />
      </div>
    </div>

    <!-- Área de contenido principal -->
    <div class="main-content">
      <!-- Sección de Modo (arriba-centro) -->
      <div class="modo-container">
        <button id="btnModoGeneral" class="modo-activo" onclick="toggleModo('general')">General</button>
        <button id="btnModoProfesor" onclick="toggleModo('profesor')">Por profesor</button>
        <button id="btnModoCurso" onclick="toggleModo('curso')">Por curso</button>
      </div>

      <!-- Botones de días (solo se muestran en modo General) -->
      <div class="top-dias" id="topDiasContainer">
        <button id="btn-lunes" onclick="mostrarDia('lunes')">Lunes</button>
        <button id="btn-martes" onclick="mostrarDia('martes')">Martes</button>
        <button id="btn-miercoles" onclick="mostrarDia('miercoles')">Miércoles</button>
        <button id="btn-jueves" onclick="mostrarDia('jueves')">Jueves</button>
        <button id="btn-viernes" onclick="mostrarDia('viernes')">Viernes</button>
      </div>

      <!-- Contenedor principal (modo General) -->
      <div class="contenedor-principal" id="contenedorGeneral">
        <!-- Día: Lunes -->
        <div id="dia-lunes" class="dia-contenedor">
          <div class="horarios-contenedor">
            <h2>Horario Lunes</h2>
            <div class="contenedor-botones-horarios">
              <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
            </div>
            <table class="tabla-horarios" id="tablaHorarios-lunes">
              <thead>
                <tr id="filaCabeceras-lunes">
                  <th class="col-hora">Hora</th>
                </tr>
              </thead>
              <tbody id="cuerpoTabla-lunes"></tbody>
            </table>
          </div>
        </div>
        
        <!-- Día: Martes -->
        <div id="dia-martes" class="dia-contenedor">
          <div class="horarios-contenedor">
            <h2>Horario Martes</h2>
            <div class="contenedor-botones-horarios">
              <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
            </div>
            <table class="tabla-horarios" id="tablaHorarios-martes">
              <thead>
                <tr id="filaCabeceras-martes">
                  <th class="col-hora">Hora</th>
                </tr>
              </thead>
              <tbody id="cuerpoTabla-martes"></tbody>
            </table>
          </div>
        </div>
        
        <!-- Día: Miércoles -->
        <div id="dia-miercoles" class="dia-contenedor">
          <div class="horarios-contenedor">
            <h2>Horario Miércoles</h2>
            <div class="contenedor-botones-horarios">
              <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
            </div>
            <table class="tabla-horarios" id="tablaHorarios-miercoles">
              <thead>
                <tr id="filaCabeceras-miercoles">
                  <th class="col-hora">Hora</th>
                </tr>
              </thead>
              <tbody id="cuerpoTabla-miercoles"></tbody>
            </table>
          </div>
        </div>
        
        <!-- Día: Jueves -->
        <div id="dia-jueves" class="dia-contenedor">
          <div class="horarios-contenedor">
            <h2>Horario Jueves</h2>
            <div class="contenedor-botones-horarios">
              <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
            </div>
            <table class="tabla-horarios" id="tablaHorarios-jueves">
              <thead>
                <tr id="filaCabeceras-jueves">
                  <th class="col-hora">Hora</th>
                </tr>
              </thead>
              <tbody id="cuerpoTabla-jueves"></tbody>
            </table>
          </div>
        </div>
        
        <!-- Día: Viernes -->
        <div id="dia-viernes" class="dia-contenedor">
          <div class="horarios-contenedor">
            <h2>Horario Viernes</h2>
            <div class="contenedor-botones-horarios">
              <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
            </div>
            <table class="tabla-horarios" id="tablaHorarios-viernes">
              <thead>
                <tr id="filaCabeceras-viernes">
                  <th class="col-hora">Hora</th>
                </tr>
              </thead>
              <tbody id="cuerpoTabla-viernes"></tbody>
            </table>
          </div>
        </div>

        <!-- Contenedor de Bloques -->
        <div id="profesorContainer">
          <button class="boton-agregar" onclick="crearBloque()">Agregar Bloque</button>
        </div>

        <!-- Sección lista de profesores -->
        <div id="seccionProfesores">
          <h3>Profesores</h3>
          <ul id="listaProfesores"></ul>
          <input type="text" id="inputNuevoProfesor" placeholder="Nuevo profesor..." />
          <button onclick="agregarProfesor()">+</button>
        </div>
      </div>

      <!-- Contenedor modo "Por Profesor" -->
      <div class="contenedor-profesor" id="contenedorProfesor">
        <h2>Horario "Por Profesor"</h2>
        <div class="prof-selector">
          <label for="profesorSelect">Seleccionar profesor:</label>
          <select id="profesorSelect" onchange="mostrarHorarioProfesor(this.value)"></select>
          <span id="profesorActivo" class="profesor-activo"></span>
        </div>

        <!-- Sección de horario "Por profesor" -->
        <div class="horarios-contenedor">
          <h2 id="profesorHorarioTitulo"></h2>
          <table class="tabla-horarios" id="tablaPorProfesor">
            <thead>
              <tr>
                <th class="col-hora">Hora</th>
                <th>Lunes</th>
                <th>Martes</th>
                <th>Miércoles</th>
                <th>Jueves</th>
                <th>Viernes</th>
              </tr>
            </thead>
            <tbody id="tablaPorProfesorBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Contenedor modo "Por Curso" -->
      <div class="contenedor-curso" id="contenedorCurso">
        <h2>Horario "Por curso"</h2>
        <div class="curso-selector">
          <label for="cursoSelect">Seleccionar curso:</label>
          <select id="cursoSelect" onchange="mostrarHorarioCurso(this.value)"></select>
          <span id="cursoActivo" class="curso-activo"></span>
        </div>

        <div class="horarios-contenedor">
          <h2 id="cursoHorarioTitulo"></h2>
          <table class="tabla-horarios" id="tablaPorCurso">
            <thead>
              <tr>
                <th class="col-hora">Hora</th>
                <th>Lunes</th>
                <th>Martes</th>
                <th>Miércoles</th>
                <th>Jueves</th>
                <th>Viernes</th>
              </tr>
            </thead>
            <tbody id="tablaPorCursoBody"></tbody>
          </table>
        </div>
      </div>

    </div><!-- Fin main-content -->

  </div><!-- Fin page-container -->

  <!-- Control de color -->
  <input type="color" id="colorPicker" oninput="cambiarColor(event)" onclick="event.stopPropagation()" />

  <!-- Tooltip de edición de bloque -->
  <div id="editTooltip">
    <label>Ramo:</label>
    <input id="inputRamo" type="text" />
    <!-- Ahora, en lugar de input, ponemos un select de profesores -->
    <label>Profesor:</label>
    <select id="selectProf"></select>
    <br/>
    <button id="saveTooltip">Guardar</button>
    <button id="cancelTooltip">Cancelar</button>
  </div>

  <!-- Librería para exportar a Excel (opcional) -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <script>
    let isReconstructing = false;
    const BLOQUES = [
      { label: "08:15", isBreak: false },
      { label: "09:00", isBreak: false },
      { label: "",      isBreak: true },
      { label: "10:00", isBreak: false },
      { label: "10:45", isBreak: false },
      { label: "",      isBreak: true },
      { label: "11:45", isBreak: false },
      { label: "12:30", isBreak: false },
      { label: "",      isBreak: true },
      { label: "14:00", isBreak: false },
      { label: "14:45", isBreak: false },
      { label: "",      isBreak: true },
      { label: "15:45", isBreak: false },
      { label: "16:30", isBreak: false },
      { label: "17:15", isBreak: false },
      { label: "18:00", isBreak: false },
      { label: "18:45", isBreak: false }
    ];
    const dias = ["lunes","martes","miercoles","jueves","viernes"];

    // Variables para guardar el último estado:
    let lastGeneralDay = "lunes";     // Último día mostrado en modo "general"
    let lastProfesorSelected = "";    // Último profesor seleccionado en modo "profesor"
    let lastCursoSelected = "";       // Último curso seleccionado en modo "curso"

    // Aquí guardaremos la lista de profesores
    let listaProfesores = [];

    let columnasGlobales = [];
    let colorPicker = null;
    let profSeleccionado = null;
    let profesorCounter = 0;
    let profesoresGuardados = [];
    let selectedBlock = null;

    // Asocia profId => número de bloques en el horario
    const profBlockCount = {};

    // Modo actual: 'general', 'profesor' o 'curso'
    let currentMode = 'general';

    window.onload = async function() {
      colorPicker = document.getElementById('colorPicker');
      dias.forEach(d => generarHorasParaDia(d));

      const savedData = localStorage.getItem('horariosData');
      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          reconstruirDesdeJSON(data);
        } catch (e) {
          console.error("Error parsing saved data:", e);
          columnasGlobales = [];
        }
      } else {
        try {
          let resp = await fetch("./horarios.json", { cache: 'no-store' });
          if (!resp.ok) throw new Error("No existe archivo");
          let data = await resp.json();
          reconstruirDesdeJSON(data);
        } catch(e) {
          columnasGlobales = [];
        }
      }
      // Mostrar el último día que teníamos (por defecto: lunes)
      mostrarDia(lastGeneralDay);
    };

    window.addEventListener('beforeunload', () => {
      const data = construirJSONCompleto();
      localStorage.setItem('horariosData', JSON.stringify(data));
    });

    function toggleModo(mode) {
      // Guardamos estado anterior:
      if (currentMode === 'general') {
        // nada más que lastGeneralDay ya se guarda cuando se hace "mostrarDia(...)"
      } else if (currentMode === 'profesor') {
        let profSelect = document.getElementById('profesorSelect');
        if (profSelect) {
          lastProfesorSelected = profSelect.value;
        }
      } else if (currentMode === 'curso') {
        let cursoSelect = document.getElementById('cursoSelect');
        if (cursoSelect) {
          lastCursoSelected = cursoSelect.value;
        }
      }

      // Cambiamos modo actual
      currentMode = mode;

      let btnGeneral = document.getElementById('btnModoGeneral');
      let btnProfesor = document.getElementById('btnModoProfesor');
      let btnCurso = document.getElementById('btnModoCurso');

      let contGeneral = document.getElementById('contenedorGeneral');
      let contProfesor = document.getElementById('contenedorProfesor');
      let contCurso = document.getElementById('contenedorCurso');

      let topDias = document.getElementById('topDiasContainer');

      // Reset botones
      btnGeneral.classList.remove('modo-activo');
      btnProfesor.classList.remove('modo-activo');
      btnCurso.classList.remove('modo-activo');

      // Reset contenedores
      contGeneral.style.display = 'none';
      contProfesor.style.display = 'none';
      contCurso.style.display = 'none';
      topDias.style.display = 'none';

      // Activar el que corresponda
      if (mode === 'general') {
        btnGeneral.classList.add('modo-activo');
        contGeneral.style.display = 'block';
        topDias.style.display = 'flex';
        // Volvemos a mostrar el último día
        mostrarDia(lastGeneralDay);
      }
      else if (mode === 'profesor') {
        btnProfesor.classList.add('modo-activo');
        contProfesor.style.display = 'block';
        buildProfesorSelect();
        // Re-seleccionar el último profesor
        let profSelect = document.getElementById('profesorSelect');
        if (profSelect && lastProfesorSelected) {
          profSelect.value = lastProfesorSelected;
          mostrarHorarioProfesor(lastProfesorSelected);
        }
      }
      else if (mode === 'curso') {
        btnCurso.classList.add('modo-activo');
        contCurso.style.display = 'block';
        buildCursoSelect();
        // Re-seleccionar el último curso
        let cursoSelect = document.getElementById('cursoSelect');
        if (cursoSelect && lastCursoSelected) {
          cursoSelect.value = lastCursoSelected;
          mostrarHorarioCurso(lastCursoSelected);
        }
      }
    }

    /* ======================= GESTIONAR PROFESORES ======================= */
    function agregarProfesor() {
      let input = document.getElementById('inputNuevoProfesor');
      let nombre = input.value.trim();
      if (!nombre) return;
      listaProfesores.push(nombre);
      input.value = "";
      refrescarListaProfesores();
    }

    function refrescarListaProfesores() {
      let ul = document.getElementById('listaProfesores');
      ul.innerHTML = "";
      listaProfesores.forEach((nombre, idx) => {
        let li = document.createElement('li');
        li.innerHTML = `
          <span>${nombre}</span>
          <button onclick="eliminarProfesor(${idx})">X</button>
        `;
        ul.appendChild(li);
      });
    }

    function eliminarProfesor(index) {
      listaProfesores.splice(index, 1);
      refrescarListaProfesores();
    }

    /* ===================== FIN GESTIÓN DE PROFESORES =================== */

    function generarHorasParaDia(dia) {
      let cuerpo = document.getElementById(`cuerpoTabla-${dia}`);
      BLOQUES.forEach(b => {
        let fila = document.createElement('tr');
        if (b.isBreak) fila.classList.add('recreo');
        let tdHora = document.createElement('td');
        tdHora.classList.add('col-hora');
        tdHora.style.pointerEvents = 'none';
        tdHora.textContent = b.label;
        fila.appendChild(tdHora);
        cuerpo.appendChild(fila);
      });
    }

    // Guarda el último día que se visualiza para recuperarlo
    function mostrarDia(dia) {
      lastGeneralDay = dia;  // Guardamos lo que el usuario está viendo
      dias.forEach(d => {
        let contenedor = document.getElementById(`dia-${d}`);
        let btnDia = document.getElementById(`btn-${d}`);
        if (!contenedor) return;
        if (d === dia) {
          contenedor.classList.add('activo');
          btnDia.classList.add('activo');
        } else {
          contenedor.classList.remove('activo');
          btnDia.classList.remove('activo');
        }
      });
    }

    /* ====================== AGREGAR COLUMNA/GESTIÓN NOMBRE ====================== */

    function agregarColumna(nombreCurso = "") {
      if (!nombreCurso && !isReconstructing) {
        nombreCurso = "Nuevo Curso " + (columnasGlobales.length + 1);
        columnasGlobales.push(nombreCurso);
      } else if (nombreCurso && !isReconstructing) {
        columnasGlobales.push(nombreCurso);
      }

      dias.forEach(dia => {
        let filaCabeceras = document.getElementById(`filaCabeceras-${dia}`);
        if (!filaCabeceras) return;

        let nuevoTh = document.createElement('th');
        nuevoTh.classList.add('editable');
        nuevoTh.contentEditable = "true";

        // El nombre que se asigna (o recupera de la reconstrucción)
        nuevoTh.textContent = nombreCurso;

        // El índice en la fila (para saber a qué curso de columnasGlobales corresponde)
        let colIndex = filaCabeceras.children.length; 
        // Pero recuerda que children[0] es la columna "Hora",
        // así que colIndex - 1 se usará para asignar en columnasGlobales

        // Al perder foco, sincroniza el texto con columnsGlobales y refresca
        nuevoTh.addEventListener('blur', e => {
          let newName = e.target.textContent.trim();
          let globalIndex = colIndex - 1;
          columnasGlobales[globalIndex] = newName;
          actualizarTodasCabeceras(globalIndex, newName);
          if (currentMode === 'curso') {
            buildCursoSelect();
          }
        });

        filaCabeceras.appendChild(nuevoTh);

        let cuerpo = document.getElementById(`cuerpoTabla-${dia}`);
        if (!cuerpo) return;
        let filas = cuerpo.getElementsByTagName('tr');
        for (let i = 0; i < filas.length; i++) {
          let nuevaTd = document.createElement('td');

          if (!filas[i].classList.contains('recreo')) {
            nuevaTd.ondragover = allowDrop;
            nuevaTd.ondragenter = handleDragEnter;
            nuevaTd.ondragleave = handleDragLeave;
            nuevaTd.ondrop = ev => drop(ev, dia);
          }
          filas[i].appendChild(nuevaTd);
        }
      });
    }

    // Actualiza todas las cabeceras (en todos los días) en la posición globalIndex
    // con el nuevo nombre newName
    function actualizarTodasCabeceras(globalIndex, newName) {
      dias.forEach(dia => {
        let filaCabeceras = document.getElementById(`filaCabeceras-${dia}`);
        if (!filaCabeceras) return;
        if (filaCabeceras.children[globalIndex + 1]) {
          filaCabeceras.children[globalIndex + 1].textContent = newName;
        }
      });
    }

    function crearBloque() {
      let profesorItem = document.createElement('div');
      profesorItem.classList.add('profesor-item');

      let profesorBlock = document.createElement('div');
      profesorBlock.classList.add('profesor-block');
      profesorBlock.id = "prof_" + Date.now() + "_" + Math.floor(Math.random()*10000);
      profesorBlock.draggable = true;
      profesorBlock.ondragstart = dragStart;
      profesorBlock.ondragend = dragEnd;
      
      profesorBlock.ondblclick = e => {
        e.stopPropagation();
        openBlockEditor(profesorBlock, e.pageX, e.pageY);
      };

      let ramoLine = document.createElement('div');
      ramoLine.classList.add('ramo-line');
      ramoLine.textContent = "Ramo " + (profesorCounter + 1);

      let profLine = document.createElement('div');
      profLine.classList.add('prof-line');
      profLine.textContent = "Profesor...?"; 

      profesorCounter++;

      profesorBlock.appendChild(ramoLine);
      profesorBlock.appendChild(profLine);

      let uniqueId = "profId_" + Date.now() + "_" + Math.floor(Math.random()*10000);
      profesorBlock.dataset.profId = uniqueId;
      profBlockCount[uniqueId] = 0; 

      let iconContainer = document.createElement('div');
      iconContainer.classList.add('profesor-item-icons');

      let colorIcon = document.createElement('img');
      colorIcon.src = "https://cdn-icons-png.flaticon.com/512/2917/2917995.png";
      colorIcon.title = "Cambiar color";
      colorIcon.onclick = ev => {
        profSeleccionado = profesorBlock;
        colorPicker.style.display = 'block';
        colorPicker.style.left = ev.pageX + 'px';
        colorPicker.style.top = ev.pageY + 'px';
        ev.stopPropagation();
      };

      let trashIcon = document.createElement('img');
      trashIcon.src = "https://cdn-icons-png.flaticon.com/512/3096/3096673.png";
      trashIcon.title = "Eliminar bloque";
      trashIcon.onclick = () => {
        delete profBlockCount[uniqueId];
        profesorItem.remove();
      };

      iconContainer.appendChild(colorIcon);
      iconContainer.appendChild(trashIcon);

      let blockCountSpan = document.createElement('span');
      blockCountSpan.classList.add('prof-count-span');
      blockCountSpan.textContent = "0";

      profesorItem.appendChild(profesorBlock);
      profesorItem.appendChild(iconContainer);
      profesorItem.appendChild(blockCountSpan);

      document.getElementById('profesorContainer').appendChild(profesorItem);
    }

    /* ===================== DRAG AND DROP ===================== */
    let draggedFromContainer = false;

    function dragStart(e) {
      e.dataTransfer.effectAllowed = "copy";
      if (!this.id) {
        this.id = "prof_" + Date.now() + "_" + Math.floor(Math.random()*10000);
      }
      e.dataTransfer.setData("text/plain", this.id);

      draggedFromContainer = this.parentNode && this.parentNode.classList && this.parentNode.classList.contains('profesor-item');
      profSeleccionado = this;
    }

    function dragEnd() {
      dias.forEach(d => checkAllRowsForConflicts(d));
    }

    function handleDragEnter(e) {
      e.currentTarget.classList.add('drag-over');
    }
    function handleDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }
    function allowDrop(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = "copy";
    }

    function drop(e, dia) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');

      if (e.target.classList.contains('profesor-block')) return;
      if (e.target.closest('.profesor-block')) return;

      let id = e.dataTransfer.getData("text/plain");
      let element = document.getElementById(id);
      if (!element) return;

      let profId = element.dataset.profId;

      if (draggedFromContainer) {
        let clone = element.cloneNode(true);
        clone.id = "prof_" + Date.now() + "_" + Math.floor(Math.random()*10000);
        clone.draggable = true;
        clone.ondragstart = dragStart;
        clone.ondragend = dragEnd;
        clone.ondblclick = ev => {
          ev.stopPropagation();
          openBlockEditor(clone, ev.pageX, ev.pageY);
        };
        clone.dataset.profId = profId;

        e.target.appendChild(clone);

        profBlockCount[profId]++;
        updateProfessorCount(profId);
      } else {
        e.target.appendChild(element);
      }

      draggedFromContainer = false;
      let row = e.target.closest('tr');
      if (row) checkRowConflicts(row);

      if (currentMode === 'profesor') {
        buildProfesorSelect();
      } else if (currentMode === 'curso') {
        buildCursoSelect();
      }
    }

    /* ===================== EDICIÓN DE BLOQUES ===================== */
    function openBlockEditor(block, x, y) {
      let tooltip = document.getElementById('editTooltip');
      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
      tooltip.style.display = 'block';

      let ramoLine = block.querySelector('.ramo-line');
      let profLine = block.querySelector('.prof-line');

      document.getElementById('inputRamo').value = ramoLine.textContent.trim();

      // Poblar el select con la lista de profesores
      let select = document.getElementById('selectProf');
      select.innerHTML = "";
      let optEmpty = document.createElement('option');
      optEmpty.value = "";
      optEmpty.textContent = "Seleccione...";
      select.appendChild(optEmpty);

      listaProfesores.forEach(nombre => {
        let opt = document.createElement('option');
        opt.value = nombre;
        opt.textContent = nombre;
        select.appendChild(opt);
      });

      select.value = profLine.textContent.trim() || "";

      document.getElementById('saveTooltip').onclick = function() {
        ramoLine.textContent = document.getElementById('inputRamo').value;
        profLine.textContent = select.value ? select.value : "Profesor...?";
        tooltip.style.display = 'none';
        if (currentMode === 'profesor') {
          buildProfesorSelect();
        } else if (currentMode === 'curso') {
          buildCursoSelect();
        }
      };

      document.getElementById('cancelTooltip').onclick = function() {
        tooltip.style.display = 'none';
      };
    }

    function cambiarColor(e) {
      if (profSeleccionado) {
        profSeleccionado.style.backgroundColor = e.target.value;
      }
      colorPicker.style.display = 'none';
    }

    // --- Clicks generales
    document.addEventListener('click', e => {
      let block = e.target.closest('.profesor-block');
      let inHorario = block?.closest('tbody');
      if (block && inHorario) {
        selectedBlock = block;
        highlightSameProfessor(selectedBlock);
      } else {
        clearHighlight();
      }
      if (
        colorPicker.style.display === 'block' &&
        !colorPicker.contains(e.target) &&
        profSeleccionado &&
        !profSeleccionado.contains(e.target)
      ) {
        colorPicker.style.display = 'none';
        profSeleccionado = null;
      }
    });

    // Tecla SUPR
    document.addEventListener('keydown', e => {
      if (e.key === "Delete" || e.keyCode === 46) {
        if (selectedBlock && selectedBlock.parentNode) {
          let pId = selectedBlock.dataset.profId;
          if (pId && profBlockCount[pId] > 0) {
            profBlockCount[pId]--;
            updateProfessorCount(pId);
          }
          selectedBlock.parentNode.removeChild(selectedBlock);
          clearHighlight();
          if (currentMode === 'profesor') {
            buildProfesorSelect();
          } else if (currentMode === 'curso') {
            buildCursoSelect();
          }
        }
      }
    });

    /* ===================== DETECCIÓN DE CONFLICTOS ===================== */
    function checkRowConflicts(row) {
      let tds = row.querySelectorAll('td');
      tds.forEach(td => td.style.backgroundColor = "");
      let profesorMap = new Map();
      tds.forEach(td => {
        let blocks = td.querySelectorAll('.profesor-block');
        blocks.forEach(block => {
          let profLine = block.querySelector('.prof-line');
          if (profLine) {
            let nombreProf = profLine.textContent.trim().toLowerCase();
            if (!profesorMap.has(nombreProf)) {
              profesorMap.set(nombreProf, []);
            }
            profesorMap.get(nombreProf).push(td);
          }
        });
      });
      profesorMap.forEach(celdas => {
        if (celdas.length > 1) {
          celdas.forEach(td => {
            td.style.backgroundColor = "red";
          });
        }
      });
    }
    function checkAllRowsForConflicts(dia) {
      let filas = document.querySelectorAll(`#cuerpoTabla-${dia} tr`);
      filas.forEach(fila => checkRowConflicts(fila));
    }

    /* ===================== AYUDANTE RGBA->HEX ===================== */
    function rgbToHex(colorStr) {
      let match = colorStr.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
      if (!match) return null;
      let r = parseInt(match[1], 10);
      let g = parseInt(match[2], 10);
      let b = parseInt(match[3], 10);
      let hex = ((r << 16) | (g << 8) | b).toString(16).toUpperCase();
      return ("000000" + hex).slice(-6);
    }

    /* ===================== GUARDAR A EXCEL ===================== */
    // Descargar Excel dependiendo del modo actual
    function descargarExcelSegunModo() {
      if (currentMode === 'general') {
        guardarExcelGeneral();
      } else if (currentMode === 'profesor') {
        guardarExcelProfesor();
      } else if (currentMode === 'curso') {
        guardarExcelCurso();
      }
    }

    function guardarExcelGeneral() {
      let wb = XLSX.utils.book_new();
      dias.forEach(dia => {
        let tabla = document.getElementById(`tablaHorarios-${dia}`);
        if (!tabla) return;
        let ws = tableToSheetConEstilos(tabla);
        XLSX.utils.book_append_sheet(wb, ws, dia.toUpperCase());
      });
      XLSX.writeFile(wb, "horarios-general.xlsx");
    }

    // Exporta la tabla #tablaPorProfesor con el nombre del profesor
    function guardarExcelProfesor() {
      let selectedProfessorValue = document.getElementById('profesorSelect').value.trim();
      if (!selectedProfessorValue) {
        selectedProfessorValue = "profesor_sin_nombre";
      }
      let safeFileName = selectedProfessorValue.toLowerCase().replace(/\s+/g, '_');

      let tabla = document.getElementById("tablaPorProfesor");
      let ws = tableToSheetConEstilos(tabla);
      let wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Profesor");
      XLSX.writeFile(wb, `horario_${safeFileName}.xlsx`);
    }

    // Exporta la tabla #tablaPorCurso con el nombre del curso
    function guardarExcelCurso() {
      let selectedCursoValue = document.getElementById('cursoSelect').value.trim();
      if (!selectedCursoValue) {
        selectedCursoValue = "curso_sin_nombre";
      }
      let safeFileName = selectedCursoValue.toLowerCase().replace(/\s+/g, '_');

      let tabla = document.getElementById("tablaPorCurso");
      let ws = tableToSheetConEstilos(tabla);
      let wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Curso");
      XLSX.writeFile(wb, `horario_${safeFileName}.xlsx`);
    }

    function tableToSheetConEstilos(tabla) {
      let aoa = [];
      let rows = tabla.querySelectorAll("tr");
      for (let r = 0; r < rows.length; r++) {
        let rowData = [];
        let cells = rows[r].querySelectorAll("th, td");
        for (let c = 0; c < cells.length; c++) {
          let cellEl = cells[c];
          let cellText = cellEl.textContent.trim();
          let styleObj = {};
          let bgColor = window.getComputedStyle(cellEl).backgroundColor;
          if (bgColor && bgColor !== "rgba(0, 0, 0, 0)" && bgColor !== "transparent") {
            let hex = rgbToHex(bgColor);
            if (hex) {
              styleObj.fill = { patternType: "solid", fgColor: { rgb: hex } };
            }
          }
          let cellObj = { t: 's', v: cellText };
          if (Object.keys(styleObj).length > 0) {
            cellObj.s = styleObj;
          }
          rowData.push(cellObj);
        }
        aoa.push(rowData);
      }
      return XLSX.utils.aoa_to_sheet(aoa);
    }

    /* ===================== GUARDAR A JSON ===================== */
    function guardarEnJSON() {
      let data = construirJSONCompleto();
      let jsonStr = JSON.stringify(data, null, 2);
      descargarArchivo(jsonStr, "horarios.json", "application/json");
      localStorage.setItem('horariosData', JSON.stringify(data));
    }

    function descargarArchivo(dataStr, fileName, mimeType) {
      let blob = new Blob([dataStr], { type: mimeType });
      let url = URL.createObjectURL(blob);
      let a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /* Estructura de data:
       {
         columnas: [...],
         dias: { lunes: [...], martes: [...], ... },
         bloques: [ ... ],
         profNames: ["Profesor Uno", "Profesor Dos", ... ]
       }
    */
    function construirJSONCompleto() {
      let data = { columnas: columnasGlobales.slice(), dias: {}, bloques: [], profNames: [...listaProfesores] };

      // Recorrer celdas de la tabla general
      dias.forEach(dia => {
        let tabla = document.getElementById(`tablaHorarios-${dia}`);
        if (!tabla) return;
        let filas = tabla.querySelectorAll("tbody tr");
        let dayMatrix = [];
        for (let i = 0; i < filas.length; i++) {
          let celdas = filas[i].querySelectorAll("td");
          let rowInfo = [];
          for (let j = 0; j < celdas.length; j++) {
            let cellData = [];
            let blocks = celdas[j].querySelectorAll(".profesor-block");
            blocks.forEach(block => {
              let ramoLine = block.querySelector(".ramo-line")?.textContent.trim() || "";
              let profLine = block.querySelector(".prof-line")?.textContent.trim() || "";
              let bgColor = window.getComputedStyle(block).backgroundColor;
              let hexColor = null;
              if (bgColor && bgColor !== "rgba(0, 0, 0, 0)" && bgColor !== "transparent") {
                hexColor = rgbToHex(bgColor);
              }
              cellData.push({ ramo: ramoLine, prof: profLine, color: hexColor });
            });
            rowInfo.push(cellData);
          }
          dayMatrix.push(rowInfo);
        }
        data.dias[dia] = dayMatrix;
      });

      // Recorrer la lista de bloques en #profesorContainer
      let blockItems = document.querySelectorAll("#profesorContainer .profesor-item");
      blockItems.forEach(item => {
        let block = item.querySelector(".profesor-block");
        if (!block) return;
        let ramo = block.querySelector(".ramo-line")?.textContent.trim() || "";
        let prof = block.querySelector(".prof-line")?.textContent.trim() || "";
        let bgColor = window.getComputedStyle(block).backgroundColor;
        let hex = null;
        if (bgColor && bgColor !== "rgba(0, 0, 0, 0)" && bgColor !== "transparent") {
          hex = rgbToHex(bgColor);
        }
        let profId = block.dataset.profId;
        let count = profBlockCount[profId] || 0;
        data.bloques.push({
          ramo: ramo,
          prof: prof,
          color: hex,
          blockCount: count.toString()
        });
      });
      return data;
    }

    function reconstruirDesdeJSON(data) {
      isReconstructing = true;
      columnasGlobales = data.columnas ? [...data.columnas] : [];
      listaProfesores = data.profNames ? [...data.profNames] : [];
      refrescarListaProfesores();

      dias.forEach(dia => {
        let tabla = document.getElementById(`tablaHorarios-${dia}`);
        if (!tabla) return;
        let filaCabeceras = tabla.querySelector("thead tr");

        // Retirar cualquier columna adicional
        while (filaCabeceras.children.length > 1) {
          filaCabeceras.removeChild(filaCabeceras.lastChild);
        }
        let tbody = tabla.querySelector("tbody");
        tbody.innerHTML = "";
        BLOQUES.forEach(b => {
          let fila = document.createElement('tr');
          if (b.isBreak) fila.classList.add('recreo');
          let tdHora = document.createElement('td');
          tdHora.classList.add('col-hora');
          tdHora.style.pointerEvents = 'none';
          tdHora.textContent = b.label;
          fila.appendChild(tdHora);
          tbody.appendChild(fila);
        });
      });

      // Volver a crear columnas
      for (let colName of columnasGlobales) {
        agregarColumna(colName);
      }

      // Rellenar
      for (let dia in data.dias) {
        let dayMatrix = data.dias[dia];
        let tabla = document.getElementById(`tablaHorarios-${dia}`);
        if (!tabla) continue;
        let filas = tabla.querySelectorAll("tbody tr");
        for (let i = 0; i < dayMatrix.length; i++) {
          if (i >= filas.length) break;
          let rowCells = dayMatrix[i];
          let celdas = filas[i].querySelectorAll("td");
          for (let j = 0; j < rowCells.length; j++) {
            if (j >= celdas.length) break;
            let blocksInfo = rowCells[j];
            blocksInfo.forEach(binfo => {
              let block = document.createElement("div");
              block.classList.add("profesor-block");
              block.id = "reconstr_" + Date.now() + "_" + Math.floor(Math.random()*10000);
              block.draggable = true;
              block.ondragstart = dragStart;
              block.ondragend = dragEnd;
              block.ondblclick = ev => {
                ev.stopPropagation();
                openBlockEditor(block, ev.pageX, ev.pageY);
              };
              let ramoLine = document.createElement('div');
              ramoLine.classList.add('ramo-line');
              ramoLine.textContent = binfo.ramo || "";
              let profLine = document.createElement('div');
              profLine.classList.add('prof-line');
              profLine.textContent = binfo.prof || "";
              block.appendChild(ramoLine);
              block.appendChild(profLine);
              if (binfo.color) {
                block.style.backgroundColor = "#" + binfo.color;
              }
              let uniqueId = "profId_" + Date.now() + "_" + Math.floor(Math.random()*10000);
              block.dataset.profId = uniqueId;
              if (!(uniqueId in profBlockCount)) {
                profBlockCount[uniqueId] = 0;
              }
              celdas[j].appendChild(block);
              profBlockCount[uniqueId]++;
            });
          }
        }
      }

      // Reconstruir contenedor de bloques
      let profContainer = document.getElementById("profesorContainer");
      profContainer.querySelectorAll(".profesor-item").forEach(p => p.remove());
      if (data.bloques) {
        data.bloques.forEach(b => {
          let profesorItem = document.createElement("div");
          profesorItem.classList.add("profesor-item");

          let profesorBlock = document.createElement("div");
          profesorBlock.classList.add("profesor-block");
          profesorBlock.id = "prof_" + Date.now() + "_" + Math.floor(Math.random()*10000);
          profesorBlock.draggable = true;
          profesorBlock.ondragstart = dragStart;
          profesorBlock.ondragend = dragEnd;
          profesorBlock.ondblclick = ev => {
            ev.stopPropagation();
            openBlockEditor(profesorBlock, ev.pageX, ev.pageY);
          };

          let ramoLine = document.createElement("div");
          ramoLine.classList.add("ramo-line");
          ramoLine.textContent = b.ramo || "";
          let profLine = document.createElement("div");
          profLine.classList.add("prof-line");
          profLine.textContent = b.prof || "";

          profesorBlock.appendChild(ramoLine);
          profesorBlock.appendChild(profLine);

          if (b.color) {
            profesorBlock.style.backgroundColor = "#" + b.color;
          }
          let uniqueId = "profId_" + Date.now() + "_" + Math.floor(Math.random()*10000);
          profesorBlock.dataset.profId = uniqueId;
          profBlockCount[uniqueId] = parseInt(b.blockCount || "0",10);

          let iconContainer = document.createElement("div");
          iconContainer.classList.add("profesor-item-icons");

          let colorIcon = document.createElement("img");
          colorIcon.src = "https://cdn-icons-png.flaticon.com/512/2917/2917995.png";
          colorIcon.title = "Cambiar color";
          colorIcon.onclick = ev => {
            profSeleccionado = profesorBlock;
            colorPicker.style.display = 'block';
            colorPicker.style.left = ev.pageX + 'px';
            colorPicker.style.top = ev.pageY + 'px';
            ev.stopPropagation();
          };

          let trashIcon = document.createElement("img");
          trashIcon.src = "https://cdn-icons-png.flaticon.com/512/3096/3096673.png";
          trashIcon.title = "Eliminar bloque";
          trashIcon.onclick = () => {
            delete profBlockCount[uniqueId];
            profesorItem.remove();
          };

          iconContainer.appendChild(colorIcon);
          iconContainer.appendChild(trashIcon);

          let blockCountSpan = document.createElement('span');
          blockCountSpan.classList.add('prof-count-span');
          blockCountSpan.textContent = profBlockCount[uniqueId].toString();

          profesorItem.appendChild(profesorBlock);
          profesorItem.appendChild(iconContainer);
          profesorItem.appendChild(blockCountSpan);

          profContainer.appendChild(profesorItem);
        });
      }
      isReconstructing = false;
    }

    /* =================== MODO "POR PROFESOR" ======================== */
    function buildProfesorSelect() {
      if (currentMode !== 'profesor') return;
      let select = document.getElementById('profesorSelect');
      if (!select) return; 
      select.innerHTML = "";

      const placeholder = document.createElement('option');
      placeholder.value = "";
      placeholder.textContent = "Seleccione un profesor...";
      select.appendChild(placeholder);

      listaProfesores.forEach(nombre => {
        let opt = document.createElement('option');
        opt.value = nombre;
        opt.textContent = nombre;
        select.appendChild(opt);
      });
    }

    function mostrarHorarioProfesor(nombreProf) {
      let profHorarioTitulo = document.getElementById('profesorHorarioTitulo');
      let profesorActivo = document.getElementById('profesorActivo');
      let tbody = document.getElementById('tablaPorProfesorBody');

      // Guardamos la última selección
      lastProfesorSelected = nombreProf;

      if (!nombreProf) {
        profHorarioTitulo.textContent = "";
        profesorActivo.textContent = "";
        tbody.innerHTML = "";
        return;
      }
      profHorarioTitulo.textContent = "Horario de " + nombreProf;
      profesorActivo.textContent = "Profesor seleccionado: " + nombreProf;

      // Limpia el tbody
      tbody.innerHTML = "";

      for (let i = 0; i < BLOQUES.length; i++) {
        let tr = document.createElement('tr');

        let tdHora = document.createElement('td');
        tdHora.classList.add('col-hora');
        tdHora.textContent = BLOQUES[i].label;
        tr.appendChild(tdHora);

        for (let d = 0; d < dias.length; d++) {
          let diaId = dias[d];
          let tdDia = document.createElement('td');

          if (!BLOQUES[i].isBreak) {
            let filaCabeceras = document.getElementById(`filaCabeceras-${diaId}`);
            let tableBody = document.getElementById(`cuerpoTabla-${diaId}`);
            if (!filaCabeceras || !tableBody) continue;
            let originalRow = tableBody.querySelectorAll('tr')[i];

            if (originalRow) {
              let originalCells = originalRow.querySelectorAll('td');
              for (let cellIndex = 1; cellIndex < originalCells.length; cellIndex++) {
                let blocks = originalCells[cellIndex].querySelectorAll('.profesor-block');
                let nombreColumna = filaCabeceras.children[cellIndex].textContent.trim();

                blocks.forEach(b => {
                  let bProfLine = b.querySelector('.prof-line')?.textContent.trim().toLowerCase();
                  if (bProfLine === nombreProf.toLowerCase()) {
                    let clone = b.cloneNode(true);
                    clone.id = "";
                    clone.draggable = false;
                    clone.ondblclick = null;
                    clone.ondragstart = null;
                    // Sustituimos la línea del "prof" con el nombre de la columna
                    let profLineClone = clone.querySelector('.prof-line');
                    if (profLineClone) {
                      profLineClone.textContent = nombreColumna;
                    }
                    tdDia.appendChild(clone);
                  }
                });
              }
            }
          } else {
            tdDia.style.backgroundColor = "#eee";
          }
          tr.appendChild(tdDia);
        }
        tbody.appendChild(tr);
      }
    }

    /* =================== MODO "POR CURSO" ======================== */
    function buildCursoSelect() {
      if (currentMode !== 'curso') return;
      let select = document.getElementById('cursoSelect');
      if (!select) return;
      select.innerHTML = "";

      const placeholder = document.createElement('option');
      placeholder.value = "";
      placeholder.textContent = "Seleccione un curso...";
      select.appendChild(placeholder);

      columnasGlobales.forEach(col => {
        let opt = document.createElement('option');
        opt.value = col;
        opt.textContent = col;
        select.appendChild(opt);
      });
    }

    function mostrarHorarioCurso(nombreCurso) {
      let cursoHorarioTitulo = document.getElementById('cursoHorarioTitulo');
      let cursoActivo = document.getElementById('cursoActivo');
      let tbody = document.getElementById('tablaPorCursoBody');

      // Guardamos la última selección
      lastCursoSelected = nombreCurso;

      if (!nombreCurso) {
        cursoHorarioTitulo.textContent = "";
        cursoActivo.textContent = "";
        tbody.innerHTML = "";
        return;
      }
      cursoHorarioTitulo.textContent = "Horario del curso: " + nombreCurso;
      cursoActivo.textContent = "Curso seleccionado: " + nombreCurso;

      tbody.innerHTML = "";

      for (let i = 0; i < BLOQUES.length; i++) {
        let tr = document.createElement('tr');

        let tdHora = document.createElement('td');
        tdHora.classList.add('col-hora');
        tdHora.textContent = BLOQUES[i].label;
        tr.appendChild(tdHora);

        for (let d = 0; d < dias.length; d++) {
          let diaId = dias[d];
          let tdDia = document.createElement('td');
          if (!BLOQUES[i].isBreak) {
            let filaCabeceras = document.getElementById(`filaCabeceras-${diaId}`);
            let tableBody = document.getElementById(`cuerpoTabla-${diaId}`);
            if (!filaCabeceras || !tableBody) continue;
            let originalRow = tableBody.querySelectorAll('tr')[i];

            if (originalRow) {
              let originalCells = originalRow.querySelectorAll('td');
              let colIndex = -1;
              for (let k = 1; k < filaCabeceras.children.length; k++) {
                if (filaCabeceras.children[k].textContent.trim() === nombreCurso) {
                  colIndex = k;
                  break;
                }
              }

              if (colIndex >= 1 && colIndex < originalCells.length) {
                let blocks = originalCells[colIndex].querySelectorAll('.profesor-block');
                blocks.forEach(b => {
                  let clone = b.cloneNode(true);
                  clone.id = "";
                  clone.draggable = false;
                  clone.ondblclick = null;
                  clone.ondragstart = null;
                  tdDia.appendChild(clone);
                });
              }
            }
          } else {
            tdDia.style.backgroundColor = "#eee";
          }
          tr.appendChild(tdDia);
        }
        tbody.appendChild(tr);
      }
    }
  </script>
</body>
</html>